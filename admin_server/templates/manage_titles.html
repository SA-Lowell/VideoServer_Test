<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Titles</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/public_html/admin.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-container, .search-container { margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .pagination { margin-top: 20px; }
        .pagination button { margin: 0 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Manage Titles</h1>
    <div class="form-container">
        <h2>Add/Edit Title</h2>
        <input type="hidden" id="title-id">
        <label>Name: <input type="text" id="title-name" required></label><br>
        <label>Description: <textarea id="title-description"></textarea></label><br>
        <button onclick="saveTitle()">Save Title</button>
        <button onclick="clearTitleForm()">Clear</button>
        <div id="form-feedback" class="success" style="display: none;"></div>
    </div>
    <div class="search-container">
        <label>Search: <input type="text" id="title-search" oninput="searchTitles(0)"></label>
    </div>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="title-table-body"></tbody>
    </table>
    <div class="pagination">
        <button onclick="searchTitles(currentPage - 1)" id="prev-page" disabled>Previous</button>
        <span id="page-info"></span>
        <button onclick="searchTitles(currentPage + 1)" id="next-page">Next</button>
    </div>
    <div id="error-message" class="error"></div>
    <script>
        let currentPage = 0;
        const limit = 10;

        function escapeJsString(str) {
            if (!str) return '';
            return str.replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        }

        function searchTitles(page) {
            currentPage = page < 0 ? 0 : page;
            const search = $('#title-search').val();
            $('#error-message').text(''); // Clear error message
            $('#form-feedback').hide(); // Hide feedback on search
            $.ajax({
                url: '/api/titles',
                method: 'GET',
                data: { search, limit, offset: currentPage * limit },
                success: function(data) {
                    $('#title-table-body').empty();
                    if (!Array.isArray(data) || data.length === 0) {
                        $('#title-table-body').append('<tr><td colspan="4">No titles found</td></tr>');
                        $('#prev-page').prop('disabled', true);
                        $('#next-page').prop('disabled', true);
                        $('#page-info').text(`Page ${currentPage + 1}`);
                        return;
                    }
                    data.forEach(title => {
                        const id = title.id || title.ID || '';
                        const name = title.name || title.Name || '';
                        const description = title.description || title.Description || '';
                        const $row = $('<tr></tr>');
                        $row.append($('<td></td>').text(id));
                        $row.append($('<td></td>').text(name)); // Removed escapeHtml, using raw text
                        $row.append($('<td></td>').text(description)); // Removed escapeHtml, using raw text
                        $row.append($('<td></td>').append(
                            $('<button></button>').text('Edit').click(function() {
                                editTitle(id, name, description);
                            }),
                            ' ',
                            $('<button></button>').text('Delete').click(function() {
                                deleteTitle(id);
                            })
                        ));
                        $('#title-table-body').append($row);
                    });
                    $('#prev-page').prop('disabled', currentPage === 0);
                    $('#next-page').prop('disabled', data.length < limit);
                    $('#page-info').text(`Page ${currentPage + 1}`);
                },
                error: function(xhr, status, error) {
                    $('#error-message').text(`Error fetching titles: ${xhr.responseJSON?.error || status || error}`);
                    $('#title-table-body').empty();
                    $('#prev-page').prop('disabled', true);
                    $('#next-page').prop('disabled', true);
                    $('#page-info').text('');
                }
            });
        }

        function saveTitle() {
            const id = $('#title-id').val();
            const title = {
                name: $('#title-name').val().trim(),
                description: $('#title-description').val().trim()
            };
            if (!title.name) {
                $('#error-message').text('Name is required');
                return;
            }
            $('#error-message').text(''); // Clear error message
            $('#form-feedback').hide(); // Hide previous feedback
            $.ajax({
                url: id ? `/api/titles/${id}` : '/api/titles',
                type: id ? 'PUT' : 'POST',
                data: JSON.stringify(title),
                contentType: 'application/json',
                success: function(data) {
                    clearTitleForm();
                    searchTitles(currentPage);
                    $('#form-feedback').text(`Title ${id ? 'updated' : 'created'} successfully!`).show();
                    setTimeout(() => $('#form-feedback').fadeOut(), 3000); // Hide after 3 seconds
                },
                error: function(xhr) {
                    $('#error-message').text(`Error: ${xhr.responseJSON?.error || 'Unknown error'}`);
                }
            });
        }

        function editTitle(id, name, description) {
            $('#title-id').val(id);
            $('#title-name').val(name); // No HTML escaping needed here, raw data for form
            $('#title-description').val(description); // No HTML escaping needed here, raw data for form
            $('#form-feedback').hide(); // Hide feedback when editing
        }

        function deleteTitle(id) {
            if (confirm('Are you sure you want to delete this title?')) {
                $.ajax({
                    url: `/api/titles/${id}`,
                    type: 'DELETE',
                    success: function() {
                        searchTitles(currentPage);
                        $('#error-message').text('');
                    },
                    error: function(xhr) {
                        $('#error-message').text(`Error: ${xhr.responseJSON?.error || 'Unknown error'}`);
                    }
                });
            }
        }

        function clearTitleForm() {
            $('#title-id').val('');
            $('#title-name').val('');
            $('#title-description').val('');
            $('#error-message').text('');
            $('#form-feedback').hide();
        }

        $(document).ready(function() {
            searchTitles(0);
        });
    </script>
</body>
</html>