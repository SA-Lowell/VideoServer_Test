<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Update Ad Break Points</title>
    <style>
        #video-player { width: 640px; height: 360px; }
        #breaks-list { margin-top: 20px; }
        .break-item { margin-bottom: 10px; }
        #folder-browser { border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow-y: auto; }
        .dir-item { cursor: pointer; color: blue; }
        .file-item { cursor: pointer; color: green; }
    </style>
</head>
<body>
    <h1>Admin Panel - Update Ad Break Points</h1>

    <h2>Titles from Database</h2>
    <ul>
        {{range .Titles}}
        <li>
            <strong>{{.Name}}</strong> (ID: {{.ID}}) - {{.Description}}
            <ul>
                {{range .Videos}}
                <li>
                    Video ID: {{.ID}}, URI: {{.URI}}
                    <button onclick="selectVideo({{.ID}}, '{{.URI}}', true)">Select from DB</button>
                    <ul>
                        {{range .Metadata}}
                        <li>Metadata: {{.TypeName}} - {{.Value}}</li>
                        {{end}}
                        {{range .Tags}}
                        <li>Tag: {{.Name}}</li>
                        {{end}}
                    </ul>
                </li>
                {{end}}
            </ul>
        </li>
        {{end}}
    </ul>

    <h2>Files from Video Folder</h2>
    <div id="current-path">Current Path: /</div>
    <div id="folder-browser"></div>
    <button onclick="navigateTo('')">Back to Root</button>

    <h2>Selected Video</h2>
    <div id="selected-info"></div>
    <video id="video-player" controls></video>
    <button id="detect-button" disabled>Detect Ad Breaks</button>

    <h2>Detected Breaks</h2>
    <div id="breaks-list"></div>

    <script>
        let selectedID = null;
        let selectedURI = null;
        let currentPath = '';

        function selectVideo(id, uri, fromDB) {
            selectedID = id;
            selectedURI = uri;
            document.getElementById('selected-info').innerHTML = `Selected Video ID: ${id}, URI: ${uri}`;
            document.getElementById('video-player').src = `/videos/${uri}`;
            document.getElementById('detect-button').disabled = false;
        }

        function loadContents(path) {
            currentPath = path;
            document.getElementById('current-path').innerHTML = `Current Path: /${path}`;
            fetch(`/list-contents?path=${encodeURIComponent(path)}`)
                .then(res => res.json())
                .then(data => {
                    const browser = document.getElementById('folder-browser');
                    browser.innerHTML = '';
                    data.contents.forEach(item => {
                        const div = document.createElement('div');
                        if (item.type === 'dir') {
                            div.className = 'dir-item';
                            div.innerHTML = `[Dir] ${item.name}`;
                            div.onclick = () => navigateTo(item.path);
                        } else {
                            div.className = 'file-item';
                            div.innerHTML = `[File] ${item.name}`;
                            div.onclick = () => {
                                // Add to DB and select
                                fetch('/add-video', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ uri: item.path, title_id: 0 })
                                }).then(res => res.json()).then(addData => {
                                    selectVideo(addData.id, item.path, false);
                                }).catch(err => console.error(err));
                            };
                        }
                        browser.appendChild(div);
                    });
                }).catch(err => console.error(err));
        }

        function navigateTo(path) {
            loadContents(path);
        }

        document.getElementById('detect-button').addEventListener('click', () => {
            const body = selectedID ? { id: selectedID } : { uri: selectedURI };
            fetch('/detect-breaks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(res => res.json()).then(data => {
                displayBreaks(data.breaks);
            }).catch(err => console.error(err));
        });

        function displayBreaks(breaks) {
            const list = document.getElementById('breaks-list');
            list.innerHTML = '';
            breaks.forEach(b => {
                const div = document.createElement('div');
                div.className = 'break-item';
                div.innerHTML = `Start: ${b.start.toFixed(4)}, Mid: ${b.mid.toFixed(4)}, End: ${b.end.toFixed(4)}`;
                const addBtn = document.createElement('button');
                addBtn.textContent = 'Add Break';
                addBtn.onclick = () => addBreak(selectedID, b.mid);
                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Preview Break';
                prevBtn.onclick = () => previewBreak(b.mid);
                div.appendChild(addBtn);
                div.appendChild(prevBtn);
                list.appendChild(div);
            });
        }

        function addBreak(id, time) {
            fetch('/add-break', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, time: time })
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    alert('Break added');
                }
            }).catch(err => console.error(err));
        }

        function previewBreak(time) {
            const video = document.getElementById('video-player');
            video.currentTime = time;
            video.play();
        }

        // Initial load
        loadContents('');
    </script>
</body>
</html>