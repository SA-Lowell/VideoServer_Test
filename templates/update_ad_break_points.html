<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Update Ad Break Points</title>
    <style>
        #video-player { width: 640px; height: 360px; }
        #breaks-list { margin-top: 20px; }
        #selected-breaks-list { margin-top: 20px; }
        #existing-breaks-list { margin-top: 20px; }
        .break-item { margin-bottom: 10px; }
        #folder-browser, #file-browser { 
            border: 1px solid #ccc; 
            padding: 10px; 
            max-height: 300px; 
            overflow-y: auto; 
            margin-top: 10px;
        }
        .dir-item, .file-item { cursor: pointer; margin-bottom: 5px; }
        .dir-item { color: blue; }
        .file-item { color: green; }
        #breadcrumb-nav { margin-top: 10px; }
        .breadcrumb-item { 
            cursor: pointer; 
            color: blue; 
            text-decoration: underline; 
            margin-right: 5px; 
        }
        .breadcrumb-item:hover { color: darkblue; }
        .breadcrumb-item::after { content: '/'; margin-left: 5px; }
        .breadcrumb-item:last-child::after { content: ''; }
        .detector-buttons { margin-top: 10px; }
        #detection-status { margin-top: 10px; color: #333; font-weight: bold; display: none; }
        #detection-status.active { display: block; }
        #breaks-select { width: 300px; }
        #selected-breaks-list .break-item button { margin-left: 10px; }
        #existing-breaks-list .break-item button { margin-left: 10px; }
        #save-breaks-button { margin-top: 10px; }
        #seek-controls { margin-top: 10px; }
        #seek-seconds { width: 60px; }
    </style>
</head>
<body>
    <h1>Admin Panel - Update Ad Break Points</h1>

    <h2>Titles from Database</h2>
    <ul>
        {{range .Titles}}
        <li>
            <strong>{{.Name}}</strong> (ID: {{.ID}}) - {{.Description}}
            <ul>
                {{range .Videos}}
                <li>
                    Video ID: {{.ID}}, URI: {{.URI}}
                    <button onclick="selectVideo({{.ID}}, '{{.URI}}', true, [{{range $index, $meta := .Metadata}}{{if eq $meta.TypeName "break_point"}}{{if $index}}, {{end}}{{$meta.Value}}{{end}}{{end}}])">Select from DB</button>
                    <ul>
                        {{range .Metadata}}
                        <li>Metadata: {{.TypeName}} - {{.Value}}</li>
                        {{end}}
                        {{range .Tags}}
                        <li>Tag: {{.Name}}</li>
                        {{end}}
                    </ul>
                </li>
                {{end}}
            </ul>
        </li>
        {{end}}
    </ul>

    <h2>Files from Video Folder</h2>
    <div id="current-path">Current Path: /</div>
    <div id="breadcrumb-nav"></div>
    <h3>Folders</h3>
    <div id="folder-browser"></div>
    <h3>Files in Current Folder</h3>
    <div id="file-browser"></div>
    <button onclick="navigateTo('')">Back to Root</button>

    <h2>Selected Video</h2>
    <div id="selected-info"></div>
    <video id="video-player" controls></video>
    <div id="seek-controls">
        <input type="number" id="seek-seconds" value="10" min="0"> seconds
        <button id="seek-backward-button">Seek Backward</button>
        <button id="seek-forward-button">Seek Forward</button>
    </div>
    <div class="detector-buttons">
        <button id="detect-fade-button" disabled>Detect Fade-to-Black Ad Breaks</button>
        <button id="detect-hard-cut-button" disabled>Detect Hard-Cut Ad Breaks</button>
    </div>
    <div id="detection-status">Detecting ad breaks, please wait...</div>

    <h2>Existing Break Points</h2>
    <div id="existing-breaks-list"></div>

    <h2>Detected Breaks</h2>
    <div id="breaks-list">
        <select id="breaks-select" size="5"></select>
        <button id="preview-break-button" disabled>Preview Selected Break</button>
        <button id="add-break-button" disabled>Add Selected Break</button>
    </div>

    <h2>Selected Breaks to Save</h2>
    <div id="selected-breaks-list"></div>
    <button id="save-breaks-button" disabled>Save Breakpoints</button>

    <script>
        let selectedID = null;
        let selectedURI = null;
        let currentPath = '';
        let detectedBreaks = [];
        let selectedBreaks = [];
        let existingBreaks = [];

        // Convert seconds to HH:MM:SS.dddd format
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            const formatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs.toFixed(4)).padStart(7, '0')}`;
            return formatted;
        }

        function selectVideo(id, uri, fromDB, metadataBreaks = []) {
            selectedID = id;
            selectedURI = uri;
            document.getElementById('selected-info').innerHTML = `Selected Video ID: ${id}, URI: ${uri}`;
            const video = document.getElementById('video-player');
            video.src = `/videos/${uri}`;
            video.load();
            document.getElementById('detect-fade-button').disabled = false;
            document.getElementById('detect-hard-cut-button').disabled = false;
            document.getElementById('add-break-button').disabled = true;
            document.getElementById('preview-break-button').disabled = true;
            document.getElementById('save-breaks-button').disabled = true;
            detectedBreaks = [];
            selectedBreaks = [];
            // Load existing break points from metadata
            existingBreaks = metadataBreaks.map(parseFloat).filter(time => !isNaN(time));
            existingBreaks.sort((a, b) => a - b);
            updateBreaksSelect();
            updateSelectedBreaksList();
            updateExistingBreaksList();
        }

        function loadContents(path) {
            currentPath = path;
            document.getElementById('current-path').innerHTML = `Current Path: /${path}`;
            updateBreadcrumbNav();
            fetch(`/list-contents?path=${encodeURIComponent(path)}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! Status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    if (!data.contents || !Array.isArray(data.contents)) {
                        throw new Error('Invalid response format: contents is missing or not an array');
                    }
                    const folderBrowser = document.getElementById('folder-browser');
                    const fileBrowser = document.getElementById('file-browser');
                    folderBrowser.innerHTML = '';
                    fileBrowser.innerHTML = '';
                    data.contents.forEach(item => {
                        const div = document.createElement('div');
                        if (item.type === 'dir') {
                            div.className = 'dir-item';
                            div.innerHTML = `[Dir] ${item.name}`;
                            div.onclick = () => navigateTo(item.path);
                            folderBrowser.appendChild(div);
                        } else {
                            div.className = 'file-item';
                            div.innerHTML = `[File] ${item.name}`;
                            div.onclick = () => {
                                fetch('/add-video', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ uri: item.path, title_id: 0 })
                                }).then(res => res.json()).then(addData => {
                                    // Fetch metadata for the video
                                    fetchMetadata(addData.id, item.path, addData.existed);
                                }).catch(err => console.error(err));
                            };
                            fileBrowser.appendChild(div);
                        }
                    });
                })
                .catch(err => {
                    console.error('Error loading contents:', err);
                    document.getElementById('folder-browser').innerHTML = `<div style="color: red;">Error: ${err.message}</div>`;
                    document.getElementById('file-browser').innerHTML = `<div style="color: red;">Error: ${err.message}</div>`;
                });
        }

        function updateBreadcrumbNav() {
            const breadcrumbNav = document.getElementById('breadcrumb-nav');
            breadcrumbNav.innerHTML = '';
            const parts = currentPath.split('/').filter(part => part.length > 0);
            let cumulativePath = '';
            const rootSpan = document.createElement('span');
            rootSpan.className = 'breadcrumb-item';
            rootSpan.innerHTML = 'Root';
            rootSpan.onclick = () => navigateTo('');
            breadcrumbNav.appendChild(rootSpan);
            parts.forEach((part, index) => {
                cumulativePath += (index > 0 ? '/' : '') + part;
                const span = document.createElement('span');
                span.className = 'breadcrumb-item';
                span.innerHTML = part;
                const pathToNavigate = cumulativePath;
                span.onclick = () => navigateTo(pathToNavigate);
                breadcrumbNav.appendChild(span);
            });
        }

        function navigateTo(path) {
            loadContents(path);
        }

        function fetchMetadata(id, path, existed) {
            fetch(`/get-video-metadata/${id}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! Status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    const metadataBreaks = data.Metadata.filter(m => m.TypeName === 'break_point').map(m => parseFloat(m.Value));
                    selectVideo(id, path, existed, metadataBreaks);
                })
                .catch(err => {
                    console.error('Error fetching metadata:', err);
                    selectVideo(id, path, existed, []);
                });
        }

        function detectBreaks(detectorType) {
            const statusDiv = document.getElementById('detection-status');
            const fadeButton = document.getElementById('detect-fade-button');
            const hardCutButton = document.getElementById('detect-hard-cut-button');
            
            statusDiv.classList.add('active');
            fadeButton.disabled = true;
            hardCutButton.disabled = true;

            const body = selectedID ? { id: selectedID, detector: detectorType } : { uri: selectedURI, detector: detectorType };
            fetch('/detect-breaks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                return res.json();
            }).then(data => {
                statusDiv.classList.remove('active');
                fadeButton.disabled = false;
                hardCutButton.disabled = false;
                detectedBreaks = data.breaks;
                updateBreaksSelect();
                const hasBreaks = detectedBreaks.length > 0;
                document.getElementById('add-break-button').disabled = !hasBreaks;
                document.getElementById('preview-break-button').disabled = !hasBreaks;
            }).catch(err => {
                statusDiv.classList.remove('active');
                fadeButton.disabled = false;
                hardCutButton.disabled = false;
                console.error(err);
                alert('Error detecting ad breaks: ' + err.message);
            });
        }

        function updateBreaksSelect() {
            const select = document.getElementById('breaks-select');
            select.innerHTML = '';
            detectedBreaks.forEach((b, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.text = `Start: ${formatTime(b.start)}, Mid: ${formatTime(b.mid)}, End: ${formatTime(b.end)}`;
                select.appendChild(option);
            });
        }

        function updateSelectedBreaksList() {
            const list = document.getElementById('selected-breaks-list');
            list.innerHTML = '';
            selectedBreaks.forEach((b, index) => {
                const div = document.createElement('div');
                div.className = 'break-item';
                div.innerHTML = `Start: ${formatTime(b.start)}, Mid: ${formatTime(b.mid)}, End: ${formatTime(b.end)}`;
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove';
                removeBtn.onclick = () => {
                    selectedBreaks.splice(index, 1);
                    updateSelectedBreaksList();
                    document.getElementById('save-breaks-button').disabled = selectedBreaks.length === 0;
                };
                const previewBtn = document.createElement('button');
                previewBtn.textContent = 'Preview Break';
                previewBtn.onclick = () => previewBreak(b.mid);
                div.appendChild(removeBtn);
                div.appendChild(previewBtn);
                list.appendChild(div);
            });
        }

        function updateExistingBreaksList() {
            const list = document.getElementById('existing-breaks-list');
            list.innerHTML = '';
            existingBreaks.forEach((time, index) => {
                const div = document.createElement('div');
                div.className = 'break-item';
                div.innerHTML = `Break Point: ${formatTime(time)}`;
                const previewBtn = document.createElement('button');
                previewBtn.textContent = 'Preview Break';
                previewBtn.onclick = () => previewBreak(time);
                div.appendChild(previewBtn);
                list.appendChild(div);
            });
        }

        document.getElementById('detect-fade-button').addEventListener('click', () => {
            detectBreaks('fade');
        });

        document.getElementById('detect-hard-cut-button').addEventListener('click', () => {
            detectBreaks('hard-cut');
        });

        document.getElementById('add-break-button').addEventListener('click', () => {
            const select = document.getElementById('breaks-select');
            const selectedIndex = select.selectedIndex;
            if (selectedIndex >= 0) {
                const breakPoint = detectedBreaks[selectedIndex];
                if (!selectedBreaks.some(b => b.mid === breakPoint.mid)) {
                    selectedBreaks.push(breakPoint);
                    updateSelectedBreaksList();
                    document.getElementById('save-breaks-button').disabled = false;
                }
            }
        });

        document.getElementById('preview-break-button').addEventListener('click', () => {
            const select = document.getElementById('breaks-select');
            const selectedIndex = select.selectedIndex;
            if (selectedIndex >= 0) {
                const breakPoint = detectedBreaks[selectedIndex];
                previewBreak(breakPoint.mid);
            }
        });

        document.getElementById('save-breaks-button').addEventListener('click', () => {
            if (selectedBreaks.length === 0) return;
            const breaks = selectedBreaks.map(b => ({ id: selectedID, time: b.mid }));
            fetch('/add-breaks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(breaks)
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    alert('Breakpoints saved successfully');
                    // Add new breaks to existing breaks
                    existingBreaks.push(...selectedBreaks.map(b => b.mid));
                    existingBreaks.sort((a, b) => a - b);
                    updateExistingBreaksList();
                    selectedBreaks = [];
                    updateSelectedBreaksList();
                    document.getElementById('save-breaks-button').disabled = true;
                }
            }).catch(err => {
                console.error(err);
                alert('Error saving breakpoints: ' + err.message);
            });
        });

        document.getElementById('seek-backward-button').addEventListener('click', () => {
            const video = document.getElementById('video-player');
            if (isNaN(video.duration)) {
                alert('Video not loaded yet. Please wait.');
                return
            }
            const seconds = parseFloat(document.getElementById('seek-seconds').value) || 0;
            video.currentTime = Math.max(0, video.currentTime - seconds);
        });

        document.getElementById('seek-forward-button').addEventListener('click', () => {
            const video = document.getElementById('video-player');
            if (isNaN(video.duration)) {
                alert('Video not loaded yet. Please wait.');
                return
            }
            const seconds = parseFloat(document.getElementById('seek-seconds').value) || 0;
            video.currentTime = Math.min(video.duration, video.currentTime + seconds);
        });

        function previewBreak(time) {
            const video = document.getElementById('video-player');
            if (isNaN(video.duration)) {
                alert('Video not loaded yet. Please wait.');
                return;
            }
            video.currentTime = time;
            video.play();
        }

        loadContents('');
    </script>
</body>
</html>